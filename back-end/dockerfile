# Stage de base
FROM node:lts-alpine AS base

WORKDIR /app

# Copier les fichiers de dépendances
COPY package*.json ./

# Installer les dépendances
RUN npm ci --only=production && npm cache clean --force

# Stage de développement
FROM node:lts-alpine AS dev

WORKDIR /app

# Copier les fichiers de dépendances
COPY package*.json ./

# Installer toutes les dépendances (dev + prod)
RUN npm ci && npm cache clean --force

# Installer nodemon globalement pour le hot-reload
RUN npm install -g nodemon

# Copier le code source
COPY . .

# Générer le client Prisma
RUN npx prisma generate

# Exposer le port
EXPOSE 8000

# Commande pour le développement avec hot-reload
CMD ["npm", "run", "start:dev"]

# Stage de build
FROM base AS build

# Copier le code source
COPY . .

# Installer les dépendances de développement temporairement
RUN npm ci

# Générer le client Prisma
RUN npx prisma generate

# Build l'application
RUN npm run build

# Stage de production
FROM base AS production

# Copier les fichiers buildés
COPY --from=build /app/dist ./dist
COPY --from=build /app/generated ./generated

# Exposer le port
EXPOSE 8000

# Commande pour la production
CMD ["npm", "run", "start:prod"]

